# Development Workflow

This project consists of two main parts:

1. **Add-on**: `ha-raumkernel-addon` (Node.js/TypeScript)
2. **Integration**: `custom_components/teufel_raumfeld_raumkernel` (Python)

The development workflow is designed to sync local changes to a remote Home Assistant instance for testing.

## Prerequisites

- SSH access to your Home Assistant instance.
- `rsync` installed on your local machine.

## Deploying Changes

1.  Copy `.env-dist` to `.env`:
2.  Edit `.env` and update your SSH connection details.

## Core Development Commands

### üöÄ Deploying Changes to a development intance of Home Assistant

The primary command for development is `./deploy_remote.sh`. It performs the following steps:

1. Runs `./ha-raumkernel-addon/prepare-build.sh` (syncs versions and copies integration code).
2. Syncs the addon files to your remote HA instance.
3. Reloads the supervisor.
4. Rebuilds and restarts the Add-on.

```bash
./deploy_remote.sh
```

### üìÅ Version Management

The version is defined in `ha-raumkernel-addon/config.yaml` (master source). To sync this version to `package.json` and the integration's `manifest.json`, run:

```bash
./ha-raumkernel-addon/sync-version.sh
```

### üì¶ Build Preparation

To bundle the current state of the integration into the addon folder (required before building the addon image), run:

```bash
./ha-raumkernel-addon/prepare-build.sh
```

## Developer Mode

The addon includes a **Developer Mode** option in `config.yaml`:

- When `DEVELOPER_MODE: true`, the addon will copy the integration files from its bundled folder to the `/config/custom_components/` directory on **every startup**, even if the version hasn't changed.
- This is useful when you are iterating quickly on the integration code and want to ensure the latest version is always active after an addon restart.

## Architecture: Auto-Install

On startup, the addon's `IntegrationManager.js` performs the following:

1. Checks if the integration exists in `/config/custom_components/`.
2. Compares the bundled version (in `ha-raumkernel-addon/integration-build-output/`) with the installed version.
3. Copies files if the integration is missing, the version is newer, or `DEVELOPER_MODE` is enabled.
4. Creates a persistent notification in Home Assistant if a Core restart is required.

## Key Files

- `ha-raumkernel-addon/rootfs/app/IntegrationManager.js`: Logic for installing/updating the integration.
- `ha-raumkernel-addon/integration-build-output/`: Bundled integration files (generated by `prepare-build.sh`). Do not edit directly.
- `deploy_remote.sh`: Main script to sync and restart the addon on a remote HA host.

## Project Structure

- `ha-raumkernel-addon/`: Home Assistant Add-on source code.
  - `rootfs/app/`: Node.js application code.
- `custom_components/teufel_raumfeld_raumkernel/`: Home Assistant Integration source code (Python).

## Useful Resources

- [Home Assistant Add-on Documentation](https://developers.home-assistant.io/docs/add-ons)
- [Home Assistant Integration Documentation](https://developers.home-assistant.io/docs/creating_integration_index)
